name: file-go

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      repoPath:
        description: 'git‰ªìÂ∫ìË∑ØÂæÑ'
        required: true
      shellUrl:
        description: 'Ëá™ÂÆö‰πâÊûÑÂª∫ÂâçËÑöÊú¨‰∏ãËΩΩË∑ØÂæÑ,ÂèØÁ©∫'
        required: false
      GO_VERSION:
        description: 'goÁâàÊú¨'
        required: false
        default: '1.19'
      UPLOAD_TRANSFER:
        description: '‰∏ä‰º†ÊúçÂä°,Â¶Çwet,ËßÅgithub.com/Mikubill/transfer#support'
        required: false
      UPLOAD_RELEASE:
        description: 'ÊòØÂê¶‰∏ä‰º†Âà∞RELEASEÈ°µÈù¢'
        required: false
        default: 'false'
      UPLOAD_TAG:
        description: '‰∏ä‰º†Êñá‰ª∂Áî®ÁöÑTAG,ÈªòËÆ§‰ΩøÁî®ÊûÑÂª∫Êó∂Èó¥'
        required: false
      platforms:
        description: 'ÈúÄË¶ÅÊûÑÂª∫ÁöÑÂπ≥Âè∞'
        required: true
        default: linux/amd64,linux/arm64,linux/386,darwin/arm64,darwin/amd64,windows/amd64

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check Out
        uses: actions/checkout@v2
      # ‰∫ßÁîütag
      - name: Generate tag
        id: tag
        run: |
          tag=$(date +'%m-%d_%H-%M-%S')
          [ ! "${{github.event.inputs.UPLOAD_TAG}}" = "" ] && tag=${{github.event.inputs.UPLOAD_TAG}}
          touch release.txt
          echo "tag=$tag" >> $GITHUB_OUTPUT

      # ÂÖãÈöÜÁõÆÊ†á,Âπ∂‰∏îÂáÜÂ§á‰∏ä‰∏ãÊñá
      - name: Git clone
        run: |
         rm -rf {*,.[^.]*,..?*}
         git clone "${{github.event.inputs.repoPath}}" .
         if [[ "${{ github.event.inputs.dockerFileUrl }}" ]] ;then wget "${{github.event.inputs.dockerFileUrl}}" -O ./Dockerfile ; fi
         if [[ "${{ github.event.inputs.shellUrl }}" ]] ;then wget "${{github.event.inputs.shellUrl}}" -O /tmp/.customize_shell.sh ; chmod +x /tmp/.customize_shell.sh && /tmp/.customize_shell.sh; fi

      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ github.event.inputs.GO_VERSION }}

#       # ÂºÄÂßãÊûÑÂª∫
#       - name: Run GoReleaser
#         uses: goreleaser/goreleaser-action@v2
#         with:
#           args: build --skip-validate --rm-dist --timeout 90m
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ÂºÄÂßãÊûÑÂª∫
      - name: Build
        run: |
          rm -rf dist
          mkdir dist
          platforms=${{ github.event.inputs.platforms }}
          echo "all platforms: $platforms"
          platforms1=(${platforms//,/ })
          for platforms2 in ${platforms1[*]}; do
            p=(${platforms2//\// })
            V_OS="${p[0]}"
            V_ARCH="${p[1]}"
            echo "strart build $platforms2 -> ${V_OS}_${V_ARCH}"
            CGO_ENABLED=0 GOOS=${V_OS} GOARCH=${V_ARCH} go build -o "dist/${V_OS}_${V_ARCH}" -ldflags="-w -s" -v &
          done
          wait
          ls -la dist
          tar -zcvf dist.tar.gz dist

      # ‰∏ä‰º†ÊûÑÂª∫‰∫ßÁâ©
      - name: Upload firmware directory
        uses: actions/upload-artifact@main
        with:
          name: ${{ steps.tag.outputs.tag }}
          path: dist/*
          retention-days: 1

      # ‰∏ä‰º†Âà∞‰∏≠ËΩ¨ÊúçÂä°
      - name: Upload firmware to transfer
        id: transfer
        if: github.event.inputs.UPLOAD_TRANSFER && !failure() && !cancelled()
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer ${{ github.event.inputs.UPLOAD_TRANSFER }} -p 64 --no-progress dist.tar.gz 2>&1 | tee transfer.log
          echo "::warning file=transfer::$(cat transfer.log | grep https)"
          echo "url=$(cat transfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT

      # ‰∫ßÁîürelease ÁöÑ‰ø°ÊÅØ
      - name: Generate release info
        id: release-tag
        if: github.event.inputs.UPLOAD_TRANSFER && !failure() && !cancelled()
        run: |
          echo "üîó [transfer](${{ steps.transfer.outputs.url }})" >> release.txt
          echo "status=success" >> $GITHUB_OUTPUT
          
      # ÁîüÊàêrelease
      - name: Upload firmware to release
        uses: softprops/action-gh-release@v1
        if: github.event.inputs.UPLOAD_RELEASE == 'true' && !failure() && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          body_path: release.txt
          files: dist/*
